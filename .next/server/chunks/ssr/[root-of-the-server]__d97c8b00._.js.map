{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 14, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/lib/auth-client.ts"],"sourcesContent":["import { inferAdditionalFields,organizationClient } from \"better-auth/client/plugins\";\nimport { createAuthClient } from \"better-auth/react\";\nimport type { auth } from \"@/lib/auth\";\n \nconst authClient = createAuthClient({\n  baseURL: process.env.PUBLIC_URL,\n  plugins: [\n    inferAdditionalFields<typeof auth>(),   \n  ],\n});\n\nexport const {signUp, signIn, signOut, useSession} = authClient"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AACA;;;AAGA,MAAM,aAAa,IAAA,uMAAgB,EAAC;IAClC,SAAS,QAAQ,GAAG,CAAC,UAAU;IAC/B,SAAS;QACP,IAAA,6MAAqB;KACtB;AACH;AAEO,MAAM,EAAC,MAAM,EAAE,MAAM,EAAE,OAAO,EAAE,UAAU,EAAC,GAAG","debugId":null}},
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/actions/register_actions.ts"],"sourcesContent":["import { FormValues } from \"@/components/register-form\";\nimport { signUp } from \"@/lib/auth-client\";\nimport { Pool } from \"pg\";\n\nfunction getLettrePromo(anneeScolaire:string, niveau:string){\n  const startYear = parseInt(anneeScolaire.split(\"-\")[0],10);\n  const index = startYear - 2006 - (parseInt(niveau,10)-1); \n      // s'incrire en 3ème année, c'est comme s'être inscrit il y a deux ans en première année  \n  return String.fromCharCode(\"a\".charCodeAt(0)+((index%26)+26)%26) // +26 pour éviter les négatifs\n}\n\nexport function sanitizePhone(input: string | null | undefined): string | null {\n  if (!input) return null;\n\n  // Supprime tout sauf les chiffres et +\n  let phone = input.replace(/[\\s./-]/g, \"\");\n\n  //Numéro commençant par 0 → transforme en +33\n  if (phone.startsWith(\"0\")) {\n    //console.log(\"catched!!!\")\n    phone = phone.slice(1);\n  }\n\n  // Vérification finale : +33 suivi de 9 chiffres\n  //const regex = /^\\+33[0-9]{9}$/;\n  //if (!regex.test(phone)) return null;\n  const regex = /^[0-9]{9}$/;\n  if (!regex.test(phone)) return null;\n\n  phone=phone.replace(/ /g,\"\")\n  console.log(phone)\n  return phone.replace(/ /g,\"\");// \"+33\"+phone;\n}\n\n\nexport function capitalizeWords(input: string): string {\n  return input\n    .replace(/-+/g,'-')\n    .split(/([ -])/g) // garde les séparateurs espace et tiret\n    .map(segment => {\n      // ne capitalise pas les séparateurs eux-mêmes\n      if (segment === \" \" || segment === \"-\") return segment;\n      return segment.charAt(0).toUpperCase() + segment.slice(1).toLowerCase();\n    })\n    .join(\"\");\n}\n\n   \n// export const formatPhoneWithSpaces = (value: string | null | undefined) => {\n//   if (!value) return \"\";\n\n//   let numero = value;\n//   if (numero.startsWith(\"0\")) {\n//     numero = numero.slice(1);\n//   }\n\n//   let digits = numero.replace(/\\D/g, \"\").slice(0, 9);\n\n//   // Regrouper 1 chiffre puis des groupes de 2\n//   return digits\n//     .replace(/(\\d{1})(\\d{2})(\\d{2})(\\d{2})(\\d{0,2})?/, (_, a, b, c, d, e) =>\n//       [a, b, c, d, e].filter(Boolean).join(\" \")\n//     )\n//     .trim();\n// };\n\n\nexport const formatPhoneWithSpaces = (value: string | null | undefined) => {  \n  if (!value) return \"\";\n\n  let numero=value\n  if (numero.startsWith(\"0\")) {\n    console.log(\"catched!!!\")\n    numero = numero.slice(1);\n  }\n\n  let digits = numero.replace(/\\D/g, \"\"); // supprimer tout sauf les chiffres\n  digits = digits.slice(0, 9); // limiter à 9 chiffres\n  \n\n  if (!digits) return \"\"; // pas de chiffres → retour vide\n\n  let formatted = \"\";\n  let addSpace = false;\n  \n  for (let i = 0; i < digits.length; i++) {\n    formatted += digits[i];\n    if(i==0)\n      formatted += \" \";\n    if (i > 1 && addSpace) {\n      formatted += \" \";\n      addSpace = false;\n    } else {\n      addSpace = true;\n    }\n  }\n  return formatted.trim();\n};\n\n\n// export async function handleSubmit(evt: React.FormEvent<HTMLFormElement>) {\n//   evt.preventDefault();\n//   const formData = new FormData(evt.currentTarget as HTMLFormElement);       \n\n//   const nom = String(formData.get(\"nom\")).toUpperCase();\n//   if (!nom) return { error: \"Please enter your nom\" };\n\n//   const prenom = String(formData.get(\"prenom\"));\n//   if (!prenom) return { error: \"Please enter your prenom\" };\n\n//   const tabPrenom = prenom.split(\" \")\n//   const longu = tabPrenom.length\n//   const name = `${nom[0]}${prenom.split(\" \").slice(0,Math.min(2,longu)).join(\"\")}`\n//     .toLowerCase()\n//     .normalize(\"NFD\")                // décompose caractères accentués\n//     .replace(/\\p{Diacritic}/ug, \"\") // supprime diacritiques\n//     .replace(/[^a-z]/g, \"\");\n\n//   const email = String(formData.get(\"email\"));\n//   if (!email) return { error: \"Please enter your email\" };\n\n//   const password = String(formData.get(\"password\"));\n//   if (!password) return { error: \"Please enter your password\" };\n\n//   const civilite = String(formData.get(\"civilite\"));\n//   //console.log(civilite)\n\n//   const pre_phone = formData.get(\"phone\")\n//   //const phone = pre_phone ? formatPhoneWithSpaces(String(pre_phone).trim()) : null;\n//   const tarif = String(formData.get(\"tarif\"))\n//   const typeContrat = String(formData.get(\"typeContrat\"))\n//   //const emaileseo = String(formData.get(\"emaileseo\"))\n//   const role = String(formData.get(\"role\"))\n\n//   const annee = String(formData.get(\"annee\"))\n//   console.log(annee)\n\n//   const niveau = String(formData.get(\"niveau\"))\n//   console.log(`niveau: ${niveau}`)\n\n//   const promoOrigine=String.fromCharCode(\n//     parseInt(annee.split('-')[0])-parseInt(niveau)+1-2006+96\n//   )\n\n//   //console.log(promoOrigine)\n//   //console.log(role)\n//   //console.log(parseInt(annee.split('–')[0])-parseInt(niveau)+1-2006+96)\n\n//   let metadata:string[] = []  \n//   if (role==\"ELING\")\n//     metadata = [annee,niveau]\n//   else if (role==\"VACAT\")\n//     metadata = [tarif,typeContrat]\n//   const id=name\n//   const user =  await signUp.email({ id ,name, email, password, nom, prenom, civilite, role, \"phoneNumber\":phone||null, metadata})\n\n  \n// }\n\nexport async function onSubmitServer(data: FormValues) {\n  // 1) Validation simple équivalente à tes checks\n  const nom = data.nom?.toUpperCase();\n  if (!nom) return { error: \"Please enter your nom\" };\n\n  const prenom = data.prenom;\n  if (!prenom) return { error: \"Please enter your prenom\" };\n\n  // 2) Construction du \"name\"\n  const tabPrenom = prenom.split(\" \");\n  const longu = tabPrenom.length;\n\n  const name = `${nom[0]}${prenom.split(\" \").slice(0, Math.min(2, longu)).join(\"\")}`\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/\\p{Diacritic}/ug, \"\")\n    .replace(/[^a-z]/g, \"\");\n\n  const nomNorma = nom.replace(\" \",\"\").toLowerCase().normalize(\"NFD\").replace(/\\p{Diacritic}/ug, \"\").replace(/[^a-z]/g, \"\");\n  const prenomNorma = prenom.replace(\" \",\"\").toLowerCase().normalize(\"NFD\").replace(/\\p{Diacritic}/ug, \"\").replace(/[^a-z]/g, \"\");\n  const emaileseoPrefixe = `${prenomNorma}.${nomNorma}`\n  // 3) Email & password\n\n  const email = data.email;\n  if (!email) return { error: \"Please enter your email\" };\n\n  const password = data.password;\n  if (!password) return { error: \"Please enter your password\" };\n\n  // 4) Civilité / téléphone / role / metadata\n  const civilite = data.civilite;\n\n  //const phone = data.phoneNumber\n  //console.log(phone)\n  let phone = data.phoneNumber;\n  if (phone) {\n    // 1. Nettoyage de sécurité (espaces, points...)\n    phone = phone.replace(/[\\s.\\-\\/]/g, \"\");\n\n    // 2. Gestion du format\n    // Si l'utilisateur a tapé \"06...\", on enlève le 0\n    if (phone.startsWith(\"0\")) {\n      phone = phone.slice(1);\n    }\n\n    // 3. Ajout du +33 pour respecter la contrainte SQL CHECK (telephone_fixe ~ '^\\+33...')\n    if (!phone.startsWith(\"+33\")) {\n      phone = \"+33\" + phone;\n    }\n  }\n  //toast.success(phone)\n    //? formatPhoneWithSpaces(String(data.phone).trim())\n    //: null;\n\n  const role = data.role;\n\n  const tarif = data.tarif;\n  const typeContrat = data.typeContrat;\n\n  const forma = data.forma\n  const annee = data.annee;\n  const niveau = data.niveau;\n  // 5) Calcul promoOrigine\n  const promoOrigine = String.fromCharCode(\n    parseInt(annee.split(\"-\")[0]) - parseInt(niveau) + 1 - 2006 + 96\n  );\n  \n\n  // 6) Metadata selon rôle\n  let metadata: string[] = [];\n  if (role === \"ELING\") metadata = [forma, promoOrigine, emaileseoPrefixe];\n  else if (role === \"VACAT\") metadata = [tarif, typeContrat, emaileseoPrefixe];\n\n  // 7) User ID final\n  const id = name;\n\n  // 8) Appel à better-auth équivalent à ton ancienne version\n  const user = await signUp.email({\n    id,\n    name,\n    email,\n    password,\n    nom,\n    prenom,\n    civilite,\n    role,\n    phoneNumber: phone || null,\n    metadata,\n  });\n\n  return { success: true, user };\n}\n\n\n\nexport async function generateUniqueName(name: string, pool:Pool) {\n  const base = name\n  let username = name;\n  let count = 1;\n  while (true) {\n    try {\n      // Tentative d'insertion temporaire via SELECT EXISTS pour vérifier unicité\n      const result = await pool.query(\n        'SELECT 1 FROM \"user\" WHERE name = $1',\n        [username]\n      );\n      if (result.rowCount === 0) {\n        return username; // unique => on retourne\n      } else {\n        username = `${base}${count}`; // sinon on incrémente\n        count++;\n      }\n    } catch (err) {\n      console.error(\"Erreur lors de la vérification du username\", err);\n      throw err;\n    }\n  }\n}\n\n\nexport async function generateUniqueEmailEseo(name: string, table: string, pool:Pool) {\n  const [base, suffixe] = name.split(\"@\")\n  let prefixe = base;\n  let count = 1;\n  while (true) {\n    try {\n      // Tentative d'insertion temporaire via SELECT EXISTS pour vérifier unicité\n      const result = await pool.query(\n        'SELECT 1 FROM '+table+' WHERE emaileseo = $1',\n        [prefixe+\"@\"+suffixe]\n      );\n      if (result.rowCount === 0) {\n        return prefixe; // unique => on retourne\n      } else {\n        prefixe = `${base}${count}`; // sinon on incrémente\n        count++;\n      }\n    } catch (err) {\n      console.error(\"Erreur lors de la vérification du username\", err);\n      throw err;\n    }\n  }\n}\n\n\n// autre méthode, \n      //SELECT NOT EXISTS (\n    //SELECT 1 FROM \"user\" WHERE maileseo = $1\n  //);"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 253, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/lib/auth.ts"],"sourcesContent":["import { betterAuth } from \"better-auth\";\nimport { phoneNumber } from \"better-auth/plugins\";\nimport { nextCookies } from \"better-auth/next-js\";\nimport { Pool } from \"pg\";\nimport { generateUniqueEmailEseo, generateUniqueName } from \"@/actions/register_actions\";\nimport { type FormValues } from \"@/components/register-form\";\n\n// 1. Définition de l'interface pour typer le \"user\" dans les hooks\n// Cela dit à TypeScript : \"T'inquiète, ces champs existent bien.\"\ninterface UserWithCustomFields {\n  id?: string;\n  email: string;\n  name?: string;\n  role?: string;\n  metadata?: string[]; // Notre champ custom\n  phoneNumber?: string;\n  emailVerified?: boolean;\n  createdAt?: Date;\n  updatedAt?: Date;\n}\n\nconst JASMIN_HOST = process.env.JASMIN_HOST;\nconst JASMIN_USER = process.env.JASMIN_USER;\nconst JASMIN_PASSWORD = process.env.JASMIN_PASSWORD;\n\nexport const pool = new Pool({\n  connectionString: process.env.DATABASE_URL,\n  // options: \"-c search_path=sys\" // Parfois nécessaire, parfois non selon ton setup\n});\n\nexport const auth = betterAuth({\n  emailAndPassword: {\n    enabled: true,\n  },\n  database: pool,\n  user: {\n    additionalFields: {\n      metadata: { type: \"string[]\", required: false },\n      // id, nom, prenom sont déjà gérés ou partiels, mais on peut les forcer si besoin\n      // Note: \"id\" est natif, pas besoin de le mettre dans additionalFields sauf cas rare\n      nom: { type: \"string\", required: false },\n      prenom: { type: \"string\", required: false },\n      civilite: { type: \"string\", required: false },\n      phoneNumber: { type: \"string\", required: false },\n      role: { type: \"string\", required: false, defaultValue: \"USER\" },\n      banned: { type: \"boolean\", required: false },\n      ban_reason: { type: \"string\", required: false },\n      ban_expires: { type: \"date\", required: false },\n    },\n  },\n  databaseHooks: {\n    user: {\n      create: {\n        // \"context\" est le 2eme argument, on ne l'utilise pas ici mais il faut respecter la signature\n        before: async (user: any) => { \n          // J'utilise 'any' temporairement ici pour débloquer ton rouge sur 'id'/'name'\n          // car le type inferré par BetterAuth est strict avant la création.\n          \n          // Logique de génération de nom unique\n          const newName = await generateUniqueName(user.name, pool);\n          \n          return {\n            data: {\n              ...user,\n              name: newName,\n              id: newName, // On force l'ID égal au username\n            }\n          };\n        },\n        after: async (user: any) => {\n          // On caste user en \"any\" ou notre interface pour accéder à metadata sans erreur\n          const typedUser = user as UserWithCustomFields;\n          \n          // Sécurité : si pas de metadata, on ne fait rien (évite le crash)\n          if (!typedUser.metadata || !typedUser.role) return;\n\n          const maxRetries = 10;\n          let attempt = 0;\n\n          // ========================\n          // GESTION VACATAIRE\n          // ========================\n          if (typedUser.role === \"VACAT\") {\n            while (attempt < maxRetries) {\n              try {\n                // metadata[2] est le préfixe email\n                const prefixe = await generateUniqueEmailEseo(typedUser.metadata[2] + \"@eseo.fr\", \"sys.prof\", pool);\n                const fullEmail = `${prefixe}@eseo.fr`;\n\n                await pool.query(\n                  `INSERT INTO sys.prof(id, emaileseo, tarif, \"typeContrat\") VALUES ($1,$2,$3,$4)`,\n                  [typedUser.id, fullEmail, parseFloat(typedUser.metadata[0]), typedUser.metadata[1]]\n                );\n                break; \n              } catch (err: any) {\n                if (err.code === '23505') { // Code erreur Unique Violation\n                  attempt++;\n                  continue;\n                }\n                // Rollback manuel (compensation)\n                await pool.query(`DELETE FROM sys.user WHERE id=$1`, [typedUser.id]);\n                throw err;\n              }\n            }\n          }\n\n          // ========================\n          // GESTION ETUDIANT\n          // ========================\n          if (typedUser.role === \"ELING\") {\n            attempt = 0;\n            while (attempt < maxRetries) {\n              try {\n                const prefixe = await generateUniqueEmailEseo(typedUser.metadata[2] + \"@reseau.eseo.fr\", \"sys.eling\", pool);\n                const fullEmail = `${prefixe}@reseau.eseo.fr`;\n                const promoOrigine = typedUser.metadata[1] + typedUser.metadata[0].toLowerCase();\n\n                await pool.query(\n                  `INSERT INTO sys.eling(id, forma, \"promoOrigine\", promo, gr, emaileseo)\n                   VALUES ($1,$2,$3,$4,$5,$6)`,\n                  [typedUser.id, typedUser.metadata[0], promoOrigine, promoOrigine, promoOrigine + \"1\", fullEmail]\n                );\n                break;\n              } catch (err: any) {\n                if (err.code === '23505') {\n                  attempt++;\n                  continue;\n                }\n                await pool.query(`DELETE FROM sys.user WHERE id=$1`, [typedUser.id]);\n                throw err;\n              }\n            }\n          }\n        },\n      },\n    },\n  },\n  plugins: [\n    nextCookies(), // Si ce plugin est toujours rouge, supprime-le, il est optionnel dans les dernières versions Next.js\n    phoneNumber({\n      sendOTP: async ({ phoneNumber, code }, request) => {\n        // Ta logique d'envoi OTP existante\n        // ... (ton code Jasmin)\n        console.log(`OTP envoyé à ${phoneNumber}: ${code}`);\n      },\n    }),\n  ],\n});\n\nexport type Session = typeof auth.$Infer.Session;"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 436, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/actions/schedule_actions.ts"],"sourcesContent":["'use server'\r\n\r\nimport { pool } from \"@/lib/auth\"; // Ton pool Postgres existant\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n// Récupérer tous les cours pour le calendrier\r\nexport async function getLessons(start: Date, end: Date) {\r\n  // On joint avec sys.prof pour avoir le nom du prof\r\n  // On joint avec scol.ue pour le titre (si besoin)\r\n  const result = await pool.query(`\r\n    SELECT \r\n      l.id, \r\n      l.deb as start, \r\n      l.fin as \"end\", \r\n      l.salle as \"resourceId\",\r\n      l.typec as type,\r\n      p.nom || ' ' || p.prenom as prof,\r\n      u.label as title\r\n    FROM scol.lecon l\r\n    LEFT JOIN sys.prof p ON l.\"profId\" = p.id\r\n    LEFT JOIN scol.ue u ON l.\"ueId\" = u.id\r\n    WHERE l.deb >= $1 AND l.fin <= $2\r\n  `, [start, end]);\r\n\r\n  // Conversion des dates pour que React comprenne\r\n  return result.rows.map(row => ({\r\n    ...row,\r\n    start: new Date(row.start),\r\n    end: new Date(row.end),\r\n    // Couleur conditionnelle selon le type (facultatif)\r\n    bgColor: row.type === 'TP' ? '#ef4444' : '#3b82f6'\r\n  }));\r\n}\r\n\r\n// Déplacer un cours (Drag & Drop)\r\nexport async function moveLesson(lessonId: string, newStart: Date, newEnd: Date, newRoomId: string) {\r\n  \r\n  // 1. DÉTECTION DE CONFLIT (Ta règle d'or)\r\n  // \"Est-ce qu'il existe un AUTRE cours dans la MÊME salle qui CHEVAUCHE mes horaires ?\"\r\n  const conflict = await pool.query(\r\n    `SELECT l.id, p.nom \r\n     FROM scol.lecon l\r\n     LEFT JOIN sys.prof p ON l.\"profId\" = p.id\r\n     WHERE l.salle = $1 \r\n       AND l.id != $2 -- On ne se compte pas soi-même\r\n       AND tstzrange(l.deb, l.fin) && tstzrange($3, $4) -- L'opérateur \"overlap\" de Postgres\r\n    `,\r\n    [newRoomId, lessonId, newStart, newEnd]\r\n  );\r\n\r\n  // S'il y a un résultat, c'est qu'il y a conflit\r\n  if (conflict.rowCount && conflict.rowCount > 0) {\r\n    const occupant = conflict.rows[0].nom || \"un autre prof\";\r\n    return { \r\n      success: false, \r\n      message: `Impossible : La salle est déjà prise par ${occupant} à cette heure.` \r\n    };\r\n  }\r\n\r\n  // 2. SI TOUT EST BON : UPDATE\r\n  try {\r\n    await pool.query(\r\n      `UPDATE scol.lecon SET deb = $1, fin = $2, salle = $3 WHERE id = $4`,\r\n      [newStart, newEnd, newRoomId, lessonId]\r\n    );\r\n    \r\n    // On rafraîchit les données de la page pour que tout le monde voie le changement\r\n    revalidatePath('/admin/planning'); \r\n    return { success: true };\r\n    \r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, message: \"Erreur technique lors de la sauvegarde.\" };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;AAEA,sMAAmC,6BAA6B;AAChE;;;;;;;;;AAGO,eAAe,WAAW,KAAW,EAAE,GAAS;IACrD,mDAAmD;IACnD,kDAAkD;IAClD,MAAM,SAAS,MAAM,0HAAI,CAAC,KAAK,CAAC,CAAC;;;;;;;;;;;;;EAajC,CAAC,EAAE;QAAC;QAAO;KAAI;IAEf,gDAAgD;IAChD,OAAO,OAAO,IAAI,CAAC,GAAG,CAAC,CAAA,MAAO,CAAC;YAC7B,GAAG,GAAG;YACN,OAAO,IAAI,KAAK,IAAI,KAAK;YACzB,KAAK,IAAI,KAAK,IAAI,GAAG;YACrB,oDAAoD;YACpD,SAAS,IAAI,IAAI,KAAK,OAAO,YAAY;QAC3C,CAAC;AACH;AAGO,eAAe,WAAW,QAAgB,EAAE,QAAc,EAAE,MAAY,EAAE,SAAiB;IAEhG,0CAA0C;IAC1C,uFAAuF;IACvF,MAAM,WAAW,MAAM,0HAAI,CAAC,KAAK,CAC/B,CAAC;;;;;;IAMD,CAAC,EACD;QAAC;QAAW;QAAU;QAAU;KAAO;IAGzC,gDAAgD;IAChD,IAAI,SAAS,QAAQ,IAAI,SAAS,QAAQ,GAAG,GAAG;QAC9C,MAAM,WAAW,SAAS,IAAI,CAAC,EAAE,CAAC,GAAG,IAAI;QACzC,OAAO;YACL,SAAS;YACT,SAAS,CAAC,yCAAyC,EAAE,SAAS,eAAe,CAAC;QAChF;IACF;IAEA,8BAA8B;IAC9B,IAAI;QACF,MAAM,0HAAI,CAAC,KAAK,CACd,CAAC,kEAAkE,CAAC,EACpE;YAAC;YAAU;YAAQ;YAAW;SAAS;QAGzC,iFAAiF;QACjF,IAAA,+IAAc,EAAC;QACf,OAAO;YAAE,SAAS;QAAK;IAEzB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC;QACd,OAAO;YAAE,SAAS;YAAO,SAAS;QAA0C;IAC9E;AACF;;;IApEsB;IA6BA;;AA7BA,+OAAA;AA6BA,+OAAA","debugId":null}},
    {"offset": {"line": 540, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/.next-internal/server/app/admin/planning/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["export {getLessons as '609f5083cd142be32326bfd72defa2b0c9f333cfa1'} from 'ACTIONS_MODULE0'\nexport {moveLesson as '78d72177924ee7672c912479bca8d305f803e355b9'} from 'ACTIONS_MODULE0'\n"],"names":[],"mappings":";AAAA","debugId":null}},
    {"offset": {"line": 577, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/components/planning-calendar.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/planning-calendar.tsx <module evaluation> from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/planning-calendar.tsx <module evaluation>\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAwS,GACrU,sEACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 591, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/components/planning-calendar.tsx/__nextjs-internal-proxy.mjs"],"sourcesContent":["// This file is generated by next-core EcmascriptClientReferenceModule.\nimport { registerClientReference } from \"react-server-dom-turbopack/server\";\nexport default registerClientReference(\n    function() { throw new Error(\"Attempted to call the default export of [project]/src/components/planning-calendar.tsx from the server, but it's on the client. It's not possible to invoke a client function from the server, it can only be rendered as a Component or passed to props of a Client Component.\"); },\n    \"[project]/src/components/planning-calendar.tsx\",\n    \"default\",\n);\n"],"names":[],"mappings":"AAAA,uEAAuE;;;;;AACvE;;uCACe,IAAA,wQAAuB,EAClC;IAAa,MAAM,IAAI,MAAM;AAAoR,GACjT,kDACA","ignoreList":[0],"debugId":null}},
    {"offset": {"line": 605, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 615, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sabri/Downloads/ESEO/S9/architecture/Veliseo/REP/src/app/admin/planning/page.tsx"],"sourcesContent":["import PlanningCalendar from \"@/components/planning-calendar\";\r\nimport { getLessons } from \"@/actions/schedule_actions\";\r\n\r\nexport default async function PlanningPage() {\r\n  // 1. On définit la plage de dates à charger (ex: Année 2025)\r\n  // Dans une vraie app, on gérerait ça dynamiquement, mais pour la démo on charge large\r\n  const start = new Date(2025, 0, 1); // 1er Janvier\r\n  const end = new Date(2025, 11, 31); // 31 Décembre\r\n\r\n  // 2. On récupère les VRAIS cours depuis Postgres\r\n  const lessons = await getLessons(start, end);\r\n\r\n  return (\r\n    <div className=\"p-6 bg-gray-50 min-h-screen\">\r\n      <div className=\"flex justify-between items-center mb-6\">\r\n        <h1 className=\"text-2xl font-bold text-gray-800\">Planning Scolaire</h1>\r\n        <div className=\"text-sm text-gray-500\">\r\n          {lessons.length} cours chargés\r\n        </div>\r\n      </div>\r\n      \r\n      {/* 3. On passe les données au calendrier */}\r\n      <PlanningCalendar initialEvents={lessons} />\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":";;;;;AAAA;AACA;;;;;;;;AAEe,eAAe;IAC5B,6DAA6D;IAC7D,sFAAsF;IACtF,MAAM,QAAQ,IAAI,KAAK,MAAM,GAAG,IAAI,cAAc;IAClD,MAAM,MAAM,IAAI,KAAK,MAAM,IAAI,KAAK,cAAc;IAElD,iDAAiD;IACjD,MAAM,UAAU,MAAM,IAAA,gJAAU,EAAC,OAAO;IAExC,qBACE,8OAAC;QAAI,WAAU;;0BACb,8OAAC;gBAAI,WAAU;;kCACb,8OAAC;wBAAG,WAAU;kCAAmC;;;;;;kCACjD,8OAAC;wBAAI,WAAU;;4BACZ,QAAQ,MAAM;4BAAC;;;;;;;;;;;;;0BAKpB,8OAAC,qJAAgB;gBAAC,eAAe;;;;;;;;;;;;AAGvC","debugId":null}}]
}